<link rel="stylesheet" href="{{ url_for('static', filename='css/easySelectable/easySelectable.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/easySelectable/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rangeSlider/wrunner-default-theme.css') }}">
{% block javascript %}
    <script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.bootpag.min.js') }}" type="text/javascript"></script>
    {% if not commited %}
        <script src="{{ url_for('static', filename='js/easySelectableBrowse.js') }}"></script>{% endif %}
    <script src="{{ url_for('static', filename='js/wrunner-jquery.js') }}"></script>
    <script src="{{ url_for('static', filename='js/wrunner-native.js') }}"></script>
    <script>
        $(document).ready(function () {
            let version_name = "{{ version.name }}"
            let items = "{{ items }}"

            $('#pageAmountSelector').change(function () {
                let optionSelected = $(this).find("option:selected");
                window.location = version_name + '&page=1&items=' + optionSelected.text();
            });

            $('#select_all_classes').change(function () {
                if ($(this).prop('checked')) {
                    $('[id^="filter_class_"]').prop('checked', true);

                } else {
                    $('[id^="filter_class_"]').prop('checked', false);
                }
            });


            $('#select_all_sets').change(function () {
                if ($(this).prop('checked')) {
                    $('[id^="filter_set_"]').prop('checked', true);

                } else {
                    $('[id^="filter_set_"]').prop('checked', false);
                }
            });

            function send_moderated_items_set() {
                let cl_filters = new Set()
                let set_filters = new Set()

                let is_any_filter_class = false
                $('[id^="filter_class_"]').each(function () {
                    is_any_filter_class = true
                    if (this.checked) {
                        cl_filters.add(this.value)
                    }
                });

                let is_any_filter_set = false
                $('[id^="filter_set_"]').each(function () {
                    is_any_filter_set = true
                    if (this.checked) {
                        set_filters.add(this.value)
                    }
                });

                let filter_dict = {
                    "committed": $('#special-control-filter1a').prop('checked'),
                    "uncommitted": $('#special-control-filter1b').prop('checked')
                }

                if (is_any_filter_class) {
                    filter_dict["class_filter"] = Array.from(cl_filters)
                }

                if (is_any_filter_set) {
                    filter_dict["filter_set"] = Array.from(set_filters)
                }


                let items_to_save = {}
                {% if not commited %}
                    if (Object.keys(moderated_items_set).length) {
                        items_to_save["moderated_items"] = moderated_items_set
                        items_to_save["node_name"] = version_name
                    }
                {% endif %}
                let filters_arr = encodeURIComponent(JSON.stringify(filter_dict));
                items_to_save = encodeURIComponent(JSON.stringify(items_to_save));
                return {filters_arr: filters_arr, items_to_save: items_to_save}
            }

            $('#apply_filters_btn').click(function () {
                let {filters_arr, items_to_save} = send_moderated_items_set();
                {% if commited %}
                    window.location = version_name + '&page=1&items=' + items + '&filters=' + filters_arr;
                {% else %}
                    $.post("/images/save_changes", items_to_save, function (response) {
                        window.location = version_name + '&page=1&items=' + items + '&filters=' + filters_arr;
                    });
                {% endif %}
            });

            $('.page-item').click(function () {
                console.log(this)
                let page = this.getAttribute('data-lp')
                let {filters_arr, items_to_save} = send_moderated_items_set();
                {% if commited %}
                    window.location = version_name + '&page=' + page + '&items=' + items;
                {% else %}
                    $.post("/images/save_changes", items_to_save, function (response) {
                        window.location = version_name + '&page=' + page + '&items=' + items;
                    });
                {% endif %}
            });

            $('#div-save-changes').click(function () {
                let {filters_arr, items_to_save} = send_moderated_items_set();
                $.post("/images/save_changes", items_to_save, function (response) {
                    if (response == "Ok") {
                        $('#navbar_text').text('Save changes');
                        $('#navbar_top').hide();
                    } else {
                        $('#navbar_text').text('Some problems occurred, saving failed. Try again');
                    }
                });
            })

            let setting = {
                roots: document.querySelector('.my-js-slider'),
                type: 'range',
                step: 1,
                rangeValue: {
                    maxValue: 0,
                    minValue: 100,
                }

            }
            let slider = wRunner(setting);
            {% if not commited %}
                $('#navbar_top').hide();
                window.addEventListener('scroll', function () {
                    if (window.scrollY > 30) {
                        document.getElementById('navbar_top').classList.add('fixed-top');
                        // add padding top to show content behind navbar
                        navbar_height = document.querySelector('.navbar').offsetHeight;
                        document.body.style.paddingTop = navbar_height + 'px';
                    } else {
                        document.getElementById('navbar_top').classList.remove('fixed-top');
                        // remove padding top from body
                        document.body.style.paddingTop = '0';
                    }
                });
            {% endif %}
        });
    </script>
{% endblock %}
{% if not commited %}
    <nav id="navbar_top" class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container" id="div-save-changes">
            <div class="navbar-brand" id="navbar_text"></div>
        </div>
    </nav>
{% endif %}
{% extends "_base.html" %}
{% block title %}Browse{% endblock %}

{% from "helpers.html" import version_details %}
{% from "_formshelper.html" import render_field %}
{% block content %}

    <div class="container">
        {{ version_details(version) }}
        <br>
        <div class="card">
            <article class="card-group-item">
                <header class="card-header collapsed" data-toggle="collapse" data-target="#collapseFilters"
                        aria-expanded="false">
                    <h5 class="card-title btn-link">Filters</h5>
                </header>
                <div class="row no-gutters">
                    <div class="col-sm-6">
                        <div class="card h-100" style="margin: 10px">
                            <div class="card-body">
                                <h5 class="card-title">Select DS classes</h5>
                                <div class="custom-control-class custom-checkbox">
                                    <span class="float-right badge badge-light round">{{ ds_length["all"] }}</span>
                                    <input type="checkbox" class="custom-control-class-input" id="select_all_classes"
                                            {% if cb_all_cl_filters %} checked {% endif %}>
                                    <label for="select_all_classes">Select all:</label>
                                </div>
                                {% for key, value in classes_info.items() %}
                                    <div class="custom-control-class custom-checkbox">
                                        <span class="float-right badge badge-light round">{{ value["amount"] }}</span>
                                        <input type="checkbox" class="custom-control-class-input"
                                               id="filter_class_{{ value["id"] }}"
                                               value="{{ key }}"
                                                {% if filters == None or 'class_filter' not in filters or key in filters['class_filter'] %}
                                               checked {% endif %}>
                                        <label for="filter_class_{{ key }}">{{ key }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="card h-100" style="margin: 10px">
                            <div class="card-body">
                                <h5 class="card-title">Select set:</h5>
                                <div class="custom-control-set custom-checkbox">
                                    <span class="float-right badge badge-light round">{{ ds_length["all"] }}</span>
                                    <input type="checkbox" class="custom-control-set-input" id="select_all_sets"
                                            {% if cb_all_set_filters %} checked {% endif %}>
                                    <label for="select_all_sets">Select all:</label>
                                </div>
                                {% for key, value in cur_ds_split.items() %}
                                    <div class="custom-control-set custom-checkbox">
                                        <span class="float-right badge badge-light round">{{ value }}</span>
                                        <input type="checkbox" class="custom-control-set-input"
                                               id="filter_set_{{ key }}"
                                               value="{{ key }}"
                                                {% if filters == None or 'set_filter' not in filters or key in filters['set_filter'] %}
                                               checked {% endif %}
                                        >
                                        <label for="filter_set_{{ key }}">{{ key }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <div class="row no-gutters">
                    <div class="col-sm-6">
                        <div class="card h-100" style="margin: 10px">
                            <div class="card-body">
                                <h5 class="card-title">Special filters</h5>
                                <div class="special-control-filters custom-checkbox">
                                    <div>
                                        <span class="float-right badge badge-light round">{{ ds_length["committed"] }}</span>
                                        <input type="checkbox" class="special-control-filters-input"
                                               id="special-control-filter1a"
                                                {% if filters != None and filters['committed'] %} checked {% endif %}>
                                        <label for="special-control-filter1a">Show committed images in the current
                                            node:</label>
                                    </div>
                                    <div>
                                        <span class="float-right badge badge-light round">{{ ds_length["uncommitted"] }}</span>
                                        <input type="checkbox" class="special-control-filters-input"
                                               id="special-control-filter1b"
                                                {% if filters != None and filters['uncommitted'] %} checked {% endif %}>
                                        <label for="special-control-filter1b">Show new images in the current
                                            node:</label>
                                    </div>
                                </div>
                                <div class="special-control-filters custom-checkbox">
                                    <span class="float-right badge badge-light round">?</span>
                                    <input type="checkbox" class="special-control-filters-input"
                                           id="special-control-filter2"
                                           checked>
                                    <label for="special-control-filter2">Show wrong classified images:</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="card h-100" style="margin: 10px">
                            <div class="card-body">
                                <h5 class="card-title">Classification confidence (%)</h5>
                                <article>
                                    <div class="my-js-slider"></div>
                                </article>

                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <div class="row text-center">
                    <div class="col-sm-12 text-center">
                        <button class="btn btn-primary btn-xs" id="apply_filters_btn">Apply filters</button>
                    </div>
                    <br>
                </div>
                <br>
            </article>

        </div>
        <hr>

        <div class="row">
            <div class="col-10">
                <div class="card-columns easySelectable" id="easySelectable">
                    {% for item in version_items %}
                        <li style="max-width: 13rem;"
                                {% if item["id"] in changed %}
                                    {#                                {% set has-class = "true" %}#}
                            has-class="true"
                                    {% if changed[item["id"]]["id"] == None %}
                            class="card border-danger mb-3 selectable-item"
                            deleted="true"
                                    {% else %}
                            class="card mb-3 selectable-item border-success"
                            deleted="false"
                                    {% endif %}
                                {% else %}
                            class="card border-secondary mb-3 selectable-item"
                            has-class="false"
                            deleted="false"
                                {% endif %}
                            has-select="false"
                            ver="{{ item["version"] }}"
                            priority="false"
                            id="{{ item["id"] }}"
                            label="{{ item["label"] }}"
                        >
                            <div class="card-header text-center" id="text_class_{{ item["id"] }}">
                                {% if "priority" in item and item["priority"] in changed %}
                                    <i class="far fa-star"></i>
                                {% else %}
                                    <i class="far fa-star "></i>
                                {% endif %}
                                {{ item["label"] }}
                                {% if item["id"] in changed %}
                                    →
                                    {% if changed[item["id"]]["id"] == None %}
                                        <i class="fas fa-trash-alt"></i>
                                    {% else %}
                                        {{ changed[item["id"]]["label"] }}
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="card-body text-primary" style="padding: 5px">
                                <img class="card-img"
                                     src="{{ url_for('images.download_file', filename=item.path) }}"
                                     alt="...***...">
                            </div>
                        </li>
                    {% endfor %}
                </div>
            </div>
            <div class="col-2">
                {% if not commited %}
                    <div class="sticky-top" style="top: 30px">
                        <div>
                            <h5>
                                Set visual class:
                                <a href="{{ url_for('maintenance.categ_help', task_id=1) }}"
                                   target="_blank" role="button">
                                    <i class="fas fa-info-circle"></i>
                                </a>
                            </h5>
                        </div>
                        {% for key, value in classes_info.items() %}
                            <div class="form-check" style="padding: 0px; margin-bottom:5px;">
                                <div class="btn-group" style="width: 100%">
                                    <button type="button" class="btn btn-outline-info" id="class_id_{{ loop.index }}"
                                            cl_id="{{ value["id"] }}" label="{{ key }}"
                                            style="width: 100%">{{ key }}</button>
                                    <button type="button"
                                            class="btn btn-outline-info dropdown-toggle dropdown-toggle-split"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                                    </button>
                                    <div class="dropdown-menu">
                                        <button type="button" class="dropdown-item"
                                                id="no_star_class_id_{{ loop.index }}"
                                                cl_id="{{ value["id"] }}" label="{{ key }}">Mark as common
                                        </button>
                                        <button type="button" class="dropdown-item" id="star_class_id_{{ loop.index }}"
                                                cl_id="{{ value["id"] }}" label="{{ key }}">Mark as important <i class="far fa-star"></i>
                                        </button>
                                        <div class="dropdown-divider"></div>
                                        <button type="button" class="dropdown-item"
                                                id="apply_all_class_id_{{ loop.index }}"
                                                cl_id="{{ value["id"] }}" label="{{ key }}">Apply to current page
                                        </button>
                                        <button type="button" class="dropdown-item"
                                                id="star_apply_all_class_id_{{ loop.index }}"
                                                cl_id="{{ value["id"] }}" label="{{ key }}">Apply to current page <i
                                                class="far fa-star"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        <br>
                        <div class="form-check" style="padding: 0px; margin-bottom:5px;">
{#                            <button type="button" class="btn btn-outline-danger" id="class_id_0"#}
{#                                    style="width: 100%">Delete#}
{#                            </button>#}

                            <div class="btn-group" style="width: 100%">
                                    <button type="button" class="btn btn-outline-danger" id="class_id_0" cl_id="0"
                                    style="width: 100%">Delete
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-danger dropdown-toggle dropdown-toggle-split"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                                    </button>
                                    <div class="dropdown-menu">
                                        <button type="button" class="dropdown-item"
                                                id="apply_all_class_id_0" cl_id="0">Apply to current page
                                        </button>
                                    </div>
                                </div>
                        </div>
                        <br>


                        <h5 id="selected_items_amount">Selected (0)</h5>
                        <h5 id="changed_items_amount">Changed (0)</h5>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <nav>
                <div style="float:left;" id="page-selection" pages="{{ pages }}" page="{{ page }}" items="{{ items }}"
                     ds_name="{{ version.name }}"></div>
                <div style="float:left; margin-left: 10px">
                    <select id="pageAmountSelector" class="form-control" name="select_elements_amount">
                        {% for val in [20,50,100,200,500] %}
                            <option value="{{ val/items }}" {% if val == items %}
                                    selected {% endif %}>{{ val }}</option>
                        {% endfor %}
                    </select>
                </div>
            </nav>
            <p></p>
            <br>
            <hr>
        </div>

    </div>

{% endblock %}
