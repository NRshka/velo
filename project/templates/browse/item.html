<link rel="stylesheet" href="{{ url_for('static', filename='css/easySelectable/easySelectable.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/easySelectable/style.css') }}">
{#<link rel="stylesheet" href="{{ url_for('static', filename='css/browse/bootstrap.min.css') }}">#}
{% block javascript %}
    <script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.bootpag.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/easySelectableBrowse.js') }}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var page =
            {{ page }}
            var version_name = "{{ version.name }}"
            var items = "{{ items }}"

            {% if filters == None %}
                var init_filters = "{{filters}}"
            {% else %}
                var init_filters = []
                {% for filter in filters %}
                    init_filters.push("{{filter}}")
                {% endfor %}
            {% endif %}
            {#var init_filters = {{ filters }}#}

            function init_class_filters(init_filters) {
                var filters = new Set();
                if (Array.isArray(init_filters)) {
                    console.log('case 1', init_filters)
                    for (var i in init_filters) {
                        filters.add(init_filters[i])
                    }
                } else {
                    console.log('case 2', init_filters)
                    {% for key, value in classes_info.items() %}
                        filters.add("{{ key }}")
                    {% endfor %}
                }
                return filters;
            }

            window.filters = init_class_filters(init_filters);
            console.log('filters:', filters)

            $('#pageAmountSelector').change(function () {
                var optionSelected = $(this).find("option:selected");
                var valueSelected = optionSelected.val();
                window.location = version_name + '&page=' + (Math.floor(page / valueSelected) + 1) + '&items=' + optionSelected.text();
            });

            $('#select_all_classes').change(function () {
                if ($(this).prop('checked')) {
                    $('[id^="filter_class_"]').prop('checked', true);
                    filters = init_class_filters();

                } else {
                    $('[id^="filter_class_"]').prop('checked', false);
                    filters = new Set();
                }
                console.log('filters:', filters)
            });

            $('[id^="filter_class_"]').change(function () {
                if ($(this).prop('checked')) {
                    filters.add($(this)[0].value)
                } else {
                    filters.delete($(this)[0].value)
                }
                console.log('filters:', filters)
            });

            $('#apply_filters_btn').click(function () {
                console.log('clicked');
                console.log(window.location.href);
                console.log(document.URL);
                console.log(window.location);
                var filters_arr = encodeURIComponent(JSON.stringify(Array.from(filters)));
                window.location = version_name + '&page=1&items=' + items + '&filters=' + filters_arr;
            });


        });

    </script>
{% endblock %}

{% extends "_base.html" %}


{% block title %}{% endblock %}
{% from "_formshelper.html" import render_field %}
{% block content %}

    <div class="container">
        <div class="card">
            <article class="card-group-item">
                <header class="card-header collapsed btn-link" data-toggle="collapse" data-target="#collapseFilters"
                        aria-expanded="false">
                    <div class="custom-control custom-checkbox">
                        <span class="float-right badge badge-light round">{{ ds_length }}</span>
                        <input type="checkbox" class="custom-control-input" id="select_all_classes" checked>
                        <label class="custom-control-label" for="select_all_classes">DS images:</label>
                    </div>
                </header>
                <div class="filter-content collapse" id="collapseFilters">
                    <div class="card-body">
                        {% for key, value in classes_info.items() %}
                            <div class="custom-control custom-checkbox">
                                <span class="float-right badge badge-light round">{{ value }}</span>
                                <input type="checkbox" class="custom-control-input" id="filter_class_{{ key }}"
                                       value="{{ key }}" {% if filters == None or key in filters %} checked {% endif %}>
                                <label class="custom-control-label" for="filter_class_{{ key }}">{{ key }}</label>
                            </div>

                        {% endfor %}
                    </div>
                    <div class="text-center">
                        <button class="btn btn-primary btn-xs" id="apply_filters_btn">Apply filters</button>
                    </div>
                    <br>
                </div>
            </article>

        </div>
        <hr>


        <div class="row">
            <div class="col-10">
                <div class="card-columns easySelectable" id="easySelectable">
                    {% for item in version_items %}
                        <li class="card border-secondary mb-3 selectable-item" style="max-width: 13rem;"
                            has-class="false" has-select="false" id="{{ item["id"] }}">
                            <div class="card-header text-center"
                                 id="text_class_{{ item["id"] }}">{{ item["label"] }}</div>
                            <div class="card-body text-primary" style="padding: 5px">
                                <img class="card-img"

                                     src="{{ url_for('images.download_file', filename=item["path"]) }}"
                                     alt="...***...">
                            </div>
                        </li>
                    {% endfor %}
                </div>
            </div>
            <div class="col-2">
                <div class="sticky-top" style="top: 30px">
                    <h5>Select visual class:</h5>
                    {% for key, value in classes_info.items() %}
                        <div class="form-check" style="padding: 0px; margin-bottom:5px;">
                            <button type="button" class="btn btn-outline-info" id="class_id_{{ loop.index }}"
                                    style="width: 100%">{{ key }}</button>
                            {#                                  <input class="form-check-input" type="radio" name="radio_class_selector"#}
                            {#                                         id="class_id_{{ loop.index }}" value="{{ categ.name }}">#}
                            {#                                  <label class="form-check-label" for="class_id_{{ categ.id }}">#}
                            {#                                    {{ categ.name }}#}
                            </label>
                        </div>
                    {% endfor %}
                    <h5 id="selected_items_amount">Selected (0)</h5>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <nav>
                <div style="float:left;" id="page-selection" pages="{{ pages }}" page="{{ page }}" items="{{ items }}"
                     ds_name="{{ version.name }}"></div>
                <div style="float:left; margin-left: 10px">
                    <select id="pageAmountSelector" class="form-control" name="select_elements_amount">
                        {% for val in [20,50,100,200,500] %}
                            <option value="{{ val/items }}" {% if val == items %}
                                    selected {% endif %}>{{ val }}</option>
                        {% endfor %}
                    </select>
                </div>
            </nav>
            <p></p>
            <br>
            <hr>
        </div>

    </div>

{% endblock %}
