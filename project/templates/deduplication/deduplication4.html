<link rel="stylesheet" href="{{ url_for('static', filename='css/easySelectable/easySelectable.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/easySelectable/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rangeSlider/wrunner-default-theme.css') }}">
{#<link rel="stylesheet" href="{{ url_for('static', filename='css/browse/bootstrap.min.css') }}">#}

{% block javascript %}
    <script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.bootpag.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/easySelectableBrowse.js') }}"></script>
    
    <script>
        $(document).ready(function () {
            let version_name = "{{ selected_ds }}"
            let items = "{{ items }}"

            $('#pageAmountSelector').change(function () {
                let optionSelected = $(this).find("option:selected");
                window.location = version_name + '&page=1&items=' + optionSelected.text();
            });

            $('.page-item').click(function () {
                console.log(this)
                let page = this.getAttribute('data-lp')
                window.location = version_name + '&page='+page+'&items=' + items;
            });
        })
    </script>
{% endblock %}

{% extends "_base.html" %}
{% block title %}Deduplication{% endblock %}
{% from "_formshelper.html" import render_field, checkbox, select %}
{% block content %}


<style>
    :root {
        --space: 2rem;
        --space-xs: calc(var(--space) / 3);
        --space-sm: calc(var(--space) / 2);
        --space-md: calc(var(--space) * 2);
      
        --color-primary: #005baf;
        --color-accent: whitesmoke;
        --color-dark: #007bfa;
        --color-mid: gray;
        --color-light: white;
        --color-highlight: dodgerblue;
      
        --radius: 0.125rem;
      }
      
      /* Here are the base styles for the main layout and sticky component */
      * {
        box-sizing: border-box;
      }
      
      main {
        display: flex;
        flex-wrap: wrap;
      }
      
      .article {
        flex-basis: 0;
        flex-grow: 999;
        min-width: 40%;
      }
      
      .sidebar {
        --offset: var(--space);
        flex-grow: 1;
        flex-basis: 100px;
        align-self: start;
        position: sticky;
        top: var(--offset);
      }
      
      .component {
        display: grid;
        grid-template-rows: auto 1fr auto;
      }
      
      .component .content {
        max-height: 500px;
        overflow-y: auto;
      }
      
      .sidebar .component {
        max-height: calc(100vh - var(--offset) * 2);
      }
      
      /*
       * Other styles
      **/
      .visually-hidden {
        clip: rect(0 0 0 0);
        clip-path: inset(50%);
        height: 1px;
        overflow: hidden;
        position: absolute;
        white-space: nowrap;
        width: 1px;
      }
      
      html,
      body {
        height: 100%;
      }
      
      [hidden] {
        display: none;
      }
      
      body {
        margin: 0 auto;
        padding: 0 var(--space);
        font-family: "Helvetica Neue", sans-serif;
        font-size: 1.25rem;
        line-height: 1.4;
        max-width: 1400px;
      }
      
      h2 {
        font-size: clamp(2rem, 4vw, 3.5rem);
        font-weight: 600;
        line-height: 1.2;
      }
      
      p {
        max-width: 70ch;
        font-size: clamp(1rem, 4vw, 1.25rem);
      }
      
      header,
      footer {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: var(--space-md) 0;
        padding: var(--space);
        height: 40vh;
        background: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 12px,
          var(--color-accent) 12px,
          var(--color-accent) 24px
        );
      }
      
      /* Until flexbox gap is supported in all modern browsers, we use the negative margin trick to create space between the children elements */
      main {
        margin-bottom: calc(var(--space-md) * -1);
        margin-left: calc(var(--space-md) * -1);
      }
      
      main > * {
        margin-bottom: var(--space-md);
        margin-left: var(--space-md);
      }
      
      article > * + * {
        margin-top: var(--space);
      }
      
      .component {
        position: relative;
        border: 1px solid var(--color-primary);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04), 0 2px 4px rgba(0, 0, 0, 0.04),
          0 4px 8px rgba(0, 0, 0, 0.03), 0 8px 16px rgba(0, 0, 0, 0.03),
          0 16px 32px rgba(0, 0, 0, 0.02), 0 32px 64px rgba(0, 0, 0, 0.02);
      }
      
      .component .header,
      .component .footer {
        padding: var(--space-sm);
        text-align: center;
      }
      
      .component .header {
        border-bottom: inherit;
      }
      
      .component .footer {
        display: flex;
        justify-content: space-between;
        border-top: inherit;
      }
      
      .component .content {
        padding: var(--space-sm);
        max-height: 500px;
        overflow-y: auto;
        color: var(--color-dark);
      }
      
      .empty-text {
        padding: var(--space);
        text-align: center;
        color: var(--color-primary);
      }
      
      .item {
        position: relative;
        appearance: none;
        display: flex;
        align-items: center;
        padding: var(--space);
        outline: none;
        width: 100%;
        background-color: var(--color-accent);
        border: 1px solid var(--color-accent);
        border-radius: var(--radius);
        cursor: pointer;
      }
      
      .item:active {
        transform: translateY(1px);
      }
      
      .item:focus {
        outline: 2px solid var(--color-highlight);
      }
      
      .item > * {
        pointer-events: none;
      }
      
      .info {
        width: 100%;
      }
      
      .title,
      .subtitle {
        width: 100%;
        height: 0.5rem;
        background-color: var(--color-primary);
        border-radius: var(--radius);
      }
      
      .title {
        margin-bottom: var(--space-xs);
        max-width: 15ch;
      }
      
      .subtitle {
        max-width: 12ch;
      }
      
      .thumbnail {
        flex-shrink: 0;
        width: var(--size);
        height: var(--size);
        background: var(--color-primary);
        border-radius: var(--radius);
      }
      
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        grid-gap: var(--space-sm);
      }
      
      .grid .item {
        flex-direction: column;
        text-align: center;
      }
      
      .grid .info {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      .grid .thumbnail {
        --size: 100px;
        margin-bottom: var(--space);
      }
      
      .list > * + * {
        margin-top: var(--space-xs);
      }
      
      .list .item {
        padding: var(--space-sm);
      }
      
      .list .item::before {
        content: "×";
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: var(--space-sm);
        font-size: 2rem;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.05rem;
        color: var(--color-primary);
        pointer-events: none;
      }
      
      .list .thumbnail {
        --size: 50px;
        margin-right: var(--space-sm);
      }
      
      .button {
        appearance: none;
        padding: var(--space-xs) var(--space-sm);
        font-family: inherit;
        font-size: 1rem;
        color: white;
        background-color: var(--color-dark);
        border: 1px solid var(--color-dark);
        cursor: pointer;
        border-radius: var(--radius);
        box-shadow: rgba(black, 0.1) 4px 4px;
      }
      
      .button:active {
        transform: translateY(1px);
        box-shadow: none;
      }
      

    ul {
        display: flex;
        list-style-type: none;
        position: relative;
    }
    li {
        display: inline-block;
        flex: 50%;
        padding: 5px;
    }
    input[type="checkbox"][id^="cb"] {
        display: none;
    }

    label {
        border: 1px solid #fff;
        padding: 10px;
        display: block;
        position: relative;
        margin: 10px;
        cursor: pointer;
    }

    label:before {
        background-color: white;
        color: white;
        content: " ";
        display: block;
        border-radius: 50%;
        border: 1px solid grey;
        position: absolute;
        top: -5px;
        left: -5px;
        width: 25px;
        height: 25px;
        text-align: center;
        line-height: 28px;
        transition-duration: 0.4s;
        transform: scale(0);
    }

    label img {
        transition-duration: 0.2s;
        transform-origin: 50% 50%;
    }

    :checked + label {
        border-color: #ddd;
    }

    :checked + label:before {
        content: "✓";
        background-color: grey;
        transform: scale(1);
    }

    :checked + label img {
        transform: scale(0.9);
        box-shadow: 0 0 5px #333;
        z-index: -1;
    }
</style>


<script type="text/javascript">
	function check_top(end_index) {
  	for (let i = 0; i <= end_index; i++) {
    	document.getElementById("cb_" + String(i) + "_1").checked = true;
    }

    return false;
  }

  function uncheck_all(count_items)  {
      for (let i = 0; i < count_items; i++) {
          element = document.getElementById("cb_" + String(i) + "_1")
          element.checked = false;
      }
  }

    async function send_remove_request(count_items) {
        let checkedIndexes = [];
        for (let i = 0; i < count_items; i++) {
            element = document.getElementById("cb_" + String(i) + "_1");
            if (element.checked) {
                checkedIndexes.push(i);
            }
        }

        let request = {
            "checkboxes": checkedIndexes,
            "task_id": "{{ task_id }}"
        };
        let url = "{{ url_for('deduplication.temporary_remove') }}";

        try {
            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(request),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            console.log('Успех');
            window.location.reload(true); 
        } catch (error) {
            console.error('Ошибка:', error);
        }
        
    }

</script>

<main>
    <article class="article">
        <form method="POST" action="{{ url_for('deduplication.save_result', task_id=task_id, selected_ds=selected_ds) }}">
            {% for item in images %}
                <div>
                    <p>Similarity: {{ item.similarity }}</p>
                    <ul>
                        <li><input type="checkbox" name="rm_checkbox" id="{{ 'cb_' + item.item_index|string + '_1' }}" value="{{ item.item_index|int }}"/>
                            <label for="{{ 'cb_' + item.item_index|string + '_1' }}">
                                <img id="{{ "image" + item.item_index|string }}" src="{{ url_for('deduplication.download_file', filename=item.image1) }}"/>
                            </label>
                        </li>
                        <li>
                            <label for="{{ 'cb_' + item.item_index|string + '_1' }}">
                                <img src="{{ url_for('deduplication.download_file', filename=item.image2) }}"/>
                            </label>
                        </li>
                    </ul>
                    <br/>
                    <button class="button" type="button" onclick="check_top({{ item.item_index }});">Check all top</button>
                </div>
                <br/>
            {% endfor %}
            <input class="button" type="submit" action="submit">
        </form>
    </article>
    <aside class="sidebar">
        <div class="component">
            <div class="footer">
                <button class="button" onclick="send_remove_request({{ count_items }});">Delete checked</button>
                <button class="button" onclick="uncheck_all({{ count_items }});">Uncheck all</button>
            </div>
        </div>
    </aside>
    
    <div class="d-flex justify-content-center">
        <nav>
            <div style="float:left;" id="page-selection" pages="{{ pages }}" page="{{ page }}" items="{{ items }}"
                    ds_name="{{ selected_ds }}"></div>
            <div style="float:left; margin-left: 10px">
                <select id="pageAmountSelector" class="form-control" name="select_elements_amount">
                    {% for val in [20,50,100,200,500] %}
                        <option value="{{ val/items }}" {% if val == items %}
                                selected {% endif %}>{{ val }}</option>
                    {% endfor %}
                </select>
            </div>
        </nav>
        <p></p>
        <br>
        <hr>
    </div>
</main>

{% endblock %}